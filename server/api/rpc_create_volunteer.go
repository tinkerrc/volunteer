package api

import (
	"context"
	"errors"

	"connectrpc.com/authn"
	"connectrpc.com/connect"

	apiv1 "github.com/tinkerrc/volunteer/proto/api/v1" // generated by protoc-gen-go
)

func (s *APIServer) CreateVolunteer(
	ctx context.Context,
	req *connect.Request[apiv1.CreateVolunteerRequest],
) (*connect.Response[apiv1.CreateVolunteerResponse], error) {
	_, err := s.ensureVolunteer(ctx)
	if err == nil {
		return nil, connect.NewError(connect.CodeAlreadyExists, errors.New("already registered"))
	}
	email, ok := authn.GetInfo(ctx).(string)
	if !ok {
		return nil, authn.Errorf("unauthenticated")
	}

	msg := req.Msg
	s.Db.Volunteer.Create().
		SetEmail(email).
		SetFirstName(msg.FirstName).
		SetMiddleName(msg.MiddleName).
		SetLastName(msg.LastName).
		SetPhone(msg.Phone).
		SetAddress(msg.Address).
		Save(ctx)

	res := connect.NewResponse(&apiv1.CreateVolunteerResponse{
		Id: "",
	})
	return res, nil
}
